#!/bin/sh

# Firefox launcher containing a Profile migration helper for
# temporary profiles used during alpha and beta phases.

# Authors:
#  Alexander Sack <asac@jwsdot.com>
#  Fabien Tassin <fta@sofaraway.org>
#  Steve Langasek <steve.langasek@canonical.com>
#  Chris Coulson <chris.coulson@canonical.com>
# License: GPLv2 or later

MOZDIR=$HOME/.mozilla
LIBDIR=@DEB_CONFIGURE_LIBEXECDIR@
GDB=/usr/bin/gdb
NAME=`which $NAME`
APPNAME=`basename $NAME`
MOZ_APP_LAUNCHER=$NAME
SERIES=@SERIES@

export MOZ_APP_LAUNCHER
unset UBUNTU_MENUPROXY

while [ ! -x "$LIBDIR/$APPNAME"-bin ] && [ -L "$NAME" ]; do
    NAME=`readlink -f $NAME`
    LIBDIR=`dirname $NAME`
done

usage () {
    $LIBDIR/$APPNAME -h | sed -e 's,/.*/,,'
    echo
    echo "      -g or --debug       Start within $GDB (Must be first)"
}

moz_debug=0
moz_debugger_args=""

while [ $# -gt 0 ]; do
    case "$1" in
        -h | --help )
            usage
            exit 0
            ;;
        -g | --debug )
            moz_debug=1
            shift
            ;;
        -a | --debugger-args )
            moz_debugger_args=$2;
            if [ "${moz_debugger_args}" != "" ] ; then
                shift 2
            else
                echo "-a requires an argument"
                exit 1
            fi
            ;;
        -- ) # Stop option processing
            shift
            break
            ;;
        * )
            break
            ;;
    esac
done

if [ -x $LIBDIR/xulapp-profilemigrator ] ; then
    if [ ! -d $MOZDIR/$APPNAME ] ; then
        $LIBDIR/xulapp-profilemigrator -s $SERIES -p $MOZDIR/$APPNAME
    elif [ -f $MOZDIR/$APPNAME.last-series ] ; then
        last_series="$(cat $MOZDIR/APPNAME.last-series)"
        if [ $SERIES -gt $last_series ] ; then
            $LIBDIR/xulapp-profilemigrator -s $SERIES -p $MOZDIR/$APPNAME
        fi
    fi
fi

echo $SERIES >> $MOZDIR/$APPNAME.last-series

LD_LIBRARY_PATH=${LIBDIR}:${LIBDIR}/plugins${LD_LIBRARY_PATH:+":$LD_LIBRARY_PATH"}
export LD_LIBRARY_PATH

if [ $moz_debug -eq 1 ] ; then
    exec $GDB $moz_debugger_args --args "$LIBDIR/$APPNAME"-bin "$@"
else
    exec "$LIBDIR/$APPNAME"-bin "$@"
fi
