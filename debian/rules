#!/usr/bin/make -f

# These are used for cross-compiling and for saving the configure script
# from having to guess our platform (since we know it already)
DEB_HOST_GNU_TYPE	?= $(shell dpkg-architecture -qDEB_HOST_GNU_TYPE)
DEB_BUILD_GNU_TYPE	?= $(shell dpkg-architecture -qDEB_BUILD_GNU_TYPE)
DEB_BUILD_ARCH		?= $(shell dpkg-architecture -qDEB_BUILD_ARCH)

DEBIAN_NAME	:= firefox-4.0
DEBIAN_APP_NAME	:= firefox
DEBIAN_VERSION	:= $(shell dpkg-parsechangelog | sed -n 's/^Version: *\(.*\)$$/\1/ p')
DEBIAN_XUL_DEV	:= $(wildcard /usr/lib/xulrunner-devel-2.0*)
DEBIAN_XUL_DIR	:= usr/lib/$(notdir $(wildcard /usr/lib/xulrunner-2.0*))
DEBIAN_FF4_DIR	 = usr/lib/$(DEBIAN_APP_NAME)-$(shell cat build-tree/mozilla/browser/config/version.txt)
DEB_TAR_SRCDIR	:= mozilla

EXTRA_SYSTEM_CONFIGURE_FLAGS = $(NULL)

FORCE_OFFICIAL_BRANDING = 1

ifneq (,$(FORCE_OFFICIAL_BRANDING))
	# official branding for beta, final and final RCs builds
	BRANDING = --enable-official-branding
	DESKTOP  = firefox-4.0-final.desktop
else
# Change branding based on Version
ifneq (,$(findstring ~cvs,$(DEBIAN_VERSION)))
	# minefield branding for cvs snapshots
	BRANDING = $(NULL)
	DESKTOP  = firefox-4.0-minefield.desktop
else
ifneq (,$(findstring ~a,$(DEBIAN_VERSION)))
	# codename branding for alpha builds
	BRANDING = --with-branding=browser/branding/unofficial
	DESKTOP  = firefox-4.0-granparadiso.desktop
else
	# official branding for beta, final and final RCs builds
	BRANDING = --enable-official-branding
	DESKTOP  = firefox-4.0-final.desktop
endif
endif
endif

# compile flags
CXX=g++-4.2
CC=gcc-4.2
LDFLAGS=$(NULL)
export CXX CC LDFLAGS

DEB_AUTO_UPDATE_AUTOCONF=2.13

include /usr/share/cdbs/1/rules/tarball.mk
include /usr/share/cdbs/1/rules/debhelper.mk
include /usr/share/cdbs/1/rules/patchsys-quilt.mk
include /usr/share/cdbs/1/class/autotools.mk
include /usr/share/mozilla-devscripts/$(DEBIAN_NAME).mk
include /usr/share/mozilla-devscripts/lp-locale-export.mk

# We don't want build-tree/mozilla/README to be shipped as a doc
DEB_INSTALL_DOCS_ALL := $(NULL)

CFLAGS = -g
CXXFLAGS = -g

ifneq (,$(findstring noopt,$(DEB_BUILD_OPTIONS)))
	EXTRA_SYSTEM_CONFIGURE_FLAGS += --disable-optimize
endif

USE_SYSTEM_CAIRO := $(shell pkg-config --exists 'cairo >= 1.5.8'; a=$$?; if test $$a != 1; then echo 1; fi)
# for old cairo versions we cannot use system cairo
ifeq (1,$(USE_SYSTEM_CAIRO))
	EXTRA_SYSTEM_CONFIGURE_FLAGS += --enable-system-cairo
else
	EXTRA_SYSTEM_CONFIGURE_FLAGS += --disable-system-cairo
endif

USE_SYSTEM_SQLITE :=  $(shell pkg-config --exists 'sqlite4 >= 4.5'; a=$$?; if test $$a != 1; then echo 1; fi)
ifeq (1,$(USE_SYSTEM_SQLITE))
	EXTRA_SYSTEM_CONFIGURE_FLAGS += --enable-system-sqlite
else
	EXTRA_SYSTEM_CONFIGURE_FLAGS += --disable-system-sqlite
endif

DEB_CONFIGURE_USER_FLAGS= \
	$(EXTRA_SYSTEM_CONFIGURE_FLAGS) \
	--disable-debug \
	--with-user-appdir=.mozilla \
	--with-system-jpeg=/usr \
	--with-system-zlib=/usr \
	--with-libxul-sdk=$(DEBIAN_XUL_DEV) \
	--disable-crashreporter \
	--disable-composer \
	--disable-elf-dynstr-gc \
	--disable-gtktest \
	--disable-install-strip \
	--disable-installer \
	--disable-ldap \
	--disable-mailnews \
	--disable-profilesharing \
	--disable-strip \
	--disable-strip-libs \
	--disable-tests \
	--disable-mochitest \
	--disable-updater \
	--disable-xprint \
	--enable-application=browser \
	--enable-canvas \
	--enable-default-toolkit=cairo-gtk2 \
	--enable-gnomevfs \
	--enable-optimize \
	--enable-pango \
	--enable-postscript \
	--enable-svg \
	--enable-mathml \
	--enable-xft \
	--enable-xinerama \
	--enable-extensions=default,-reporter \
	--enable-single-profile \
	--enable-system-myspell \
	--with-distribution-id=com.ubuntu \
	$(BRANDING)

UUDECODE = \
	debsearch.gif \
	$(NULL)

DEBIAN_EXECUTABLES = \
	firefox.sh \
	$(NULL)

subst_files = \
	debian/$(DEBIAN_NAME)-gnome-support.postinst \
	debian/$(DEBIAN_NAME).postinst \
	debian/firefox.sh \
	$(NULL)

%: %.in
	sed -e 's,@LIBDIR@,/$(DEBIAN_FF4_DIR),g' < $< > $@

debian/firefox.sh: debian/firefox.sh.in
	sed -e 's,@LIBDIR@,/$(DEBIAN_FF4_DIR),g' < $< > $@

debian/migrator/ffox-4-beta-profile-migration-dialog: debian/migrator/main.c
	$(CC) $(CFLAGS) -o $@ $< $(shell pkg-config --cflags --libs gtk+-2.0)

binary-install/$(DEBIAN_NAME)::
	touch debian/$(DEBIAN_NAME)/$(DEBIAN_FF4_DIR)/.autoreg
	dh_install debian/firefox.sh $(DEBIAN_FF4_DIR)
	dh_install debian/firefox.cfg $(DEBIAN_FF4_DIR)
	dh_install debian/$(DEBIAN_NAME)-restart-required.update-notifier $(DEBIAN_FF4_DIR)
	dh_install debian/migrator/ffox-4-beta-profile-migration-dialog $(DEBIAN_FF4_DIR)
	dh_link $(DEBIAN_FF4_DIR)/firefox.sh usr/bin/$(DEBIAN_NAME)
	dh_link usr/lib/firefox-addons/extensions $(DEBIAN_FF4_DIR)/extensions
	dh_link usr/lib/firefox-addons/plugins $(DEBIAN_FF4_DIR)/plugins
	dh_link usr/lib/firefox-addons/searchplugins $(DEBIAN_FF4_DIR)/searchplugins
	dh_link etc/$(DEBIAN_NAME)/pref $(DEBIAN_FF4_DIR)/defaults/syspref
	dh_link etc/$(DEBIAN_NAME)/profile $(DEBIAN_FF4_DIR)/defaults/profile
	dh_link $(DEBIAN_FF4_DIR)/icons/mozicon128.png usr/share/pixmaps/$(DEBIAN_NAME).png
	dh_link usr/share/myspell/dicts $(DEBIAN_FF4_DIR)/dictionaries

binary-post-install/$(DEBIAN_NAME):: compare

pre-build:: $(subst_files) debian/migrator/ffox-4-beta-profile-migration-dialog
	set -e; for i in $(UUDECODE); do \
		uudecode -o debian/$$i debian/$$i.uu; \
		done ; \
		cp debian/$(DESKTOP) debian/firefox.desktop; \
		for i in $(DEBIAN_EXECUTABLES); do \
			chmod a+x debian/$$i; \
		done

clean::
	set -e; for i in $(UUDECODE); do \
		rm -f debian/$$i; \
		done ; 
	rm -f debian/$(DEBIAN_NAME).desktop
	rm -f $(subst_files)
	rm -f debian/migrator/ffox-4-beta-profile-migration-dialog
	rm -f debian/migrator/*~

