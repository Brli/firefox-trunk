#!/usr/bin/perl

use strict;
use warnings;

my $app_name;
my $out_dir;
my %ipvars;

while (@ARGV) {
    my $arg = shift(@ARGV);
    if ($arg eq "-a") {
        $app_name = shift(@ARGV);
    } elsif ($arg eq "-o") {
        $out_dir = shift(@ARGV);
    } elsif (index($arg, "-D") eq 0) {
        $arg =~ s/^\-D//;
        my $key = $arg;
        my $value = $arg;
        $key =~ s/([^\=]*)\=([^\=]*)/$1/;
        $value =~ s/([^\=]*)\=([^\=]*)/$2/;
        ($value ne "") and $ipvars{$key} = $value;
    }
}

(defined($app_name)) || die "Need to specify an appname";
(defined($out_dir)) || die "Need to specify a destination";

my %converter = (
    "APP" => "$app_name",
    "DEV" => "$app_name-dev",
    "DBG" => "$app_name-dbg",
    "GS" => "$app_name-gnome-support",
    "PROVIDES" => "Provides",
    "BREAKS" => "Breaks",
    "REPLACES" => "Replaces",
    "CONFLICTS" => "Conflicts"
);

my %substvars;

my @params = keys(%ipvars);
foreach my $param (@params) {
    my $value = $ipvars{$param};
    my $pkg = $param;
    my $rel = $param;
    $pkg =~ s/([^_]*)_(.*)/$1/;
    $rel =~ s/([^_]*)_(.*)/$2/;
    my $pkgname = $converter{$pkg};
    $rel = $converter{$rel};
    $pkg = lc($pkg);
    $substvars{$pkgname}{"$pkg:$rel"} = "$value";
}

my @pkgs = keys(%substvars);
foreach my $pkg (@pkgs) {
    my $pkgvars = $substvars{$pkg};
    open(my $outfile, ">$out_dir/$pkg.substvars.tmp") || die "Cannot open $out_dir/$pkg.substvars.tmp";
    if (-e "$out_dir/$pkg.substvars") {
        open(my $infile, "$out_dir/$pkg.substvars");
        while(<$infile>) {
            my $line = $_;
            my $var = $line;
            $var =~ s/([^\=]*)\=(.*)/$1/;
            chomp($var);
            if (exists($$pkgvars{$var})) {
                print $outfile "$var=$$pkgvars{$var}";
                delete($$pkgvars{$var});
            } else {
                print $outfile "$line";
            }
        }
        close($infile);
    }
    my @vars = keys(%$pkgvars);
    foreach my $var (@vars) {
        print $outfile "$var=$$pkgvars{$var}\n";
    }
    close($outfile);

    system("mv $out_dir/$pkg.substvars.tmp $out_dir/$pkg.substvars");
}
