Index: firefox-trunk-20.0~a1~hg20121121r113867/testing/mochitest/browser-harness.xul
===================================================================
--- firefox-trunk-20.0~a1~hg20121121r113867.orig/testing/mochitest/browser-harness.xul	2012-11-21 23:22:36.000000000 +0000
+++ firefox-trunk-20.0~a1~hg20121121r113867/testing/mochitest/browser-harness.xul	2012-11-22 23:28:52.113692615 +0000
@@ -11,6 +11,8 @@
         width="1024">
   <script src="chrome://mochikit/content/tests/SimpleTest/MozillaLogger.js"/>
   <script src="chrome://mochikit/content/tests/SimpleTest/LogController.js"/>
+  <script src="chrome://mochikit/content/tests/SimpleTest/TestRunner.js"/>
+  <script src="chrome://mochikit/content/tests/SimpleTest/setup.js"/>
   <script src="chrome://mochikit/content/chrome-harness.js"/>
   <style xmlns="http://www.w3.org/1999/xhtml"><![CDATA[
     #results {
@@ -175,10 +177,11 @@
       scriptLoader.loadSubScript('chrome://mochikit/content/server.js',
                                  srvScope);
 
-      var fileNames = [];
       var fileNameRegexp = /browser_.+\.js$/;
-      srvScope.arrayOfTestFiles(links, fileNames, fileNameRegexp);
-      return fileNames.map(function (f) new browserTest(f));
+      srvScope.arrayOfTestFiles(links, gTestList, fileNameRegexp);
+      gTestBase = "chrome://mochitests/content";
+      gTestList = filterTests(gConfig.testManifest, gConfig.runOnly);
+      return gTestList.map(function (f) new browserTest(f));
     }
 
     function setStatus(aStatusString) {
Index: firefox-trunk-20.0~a1~hg20121121r113867/testing/mochitest/tests/SimpleTest/setup.js
===================================================================
--- firefox-trunk-20.0~a1~hg20121121r113867.orig/testing/mochitest/tests/SimpleTest/setup.js	2012-11-21 23:22:36.000000000 +0000
+++ firefox-trunk-20.0~a1~hg20121121r113867/testing/mochitest/tests/SimpleTest/setup.js	2012-11-22 23:16:14.989665840 +0000
@@ -105,6 +105,7 @@
 }
 
 var gTestList = [];
+var gTestBase;
 var RunSet = {}
 RunSet.runall = function(e) {
   // Filter tests to include|exclude tests based on data in params.filter.
@@ -235,10 +236,10 @@
       for (var f in runtests) {
         // Remove leading /tests/ if exists
         file = f.replace(/^\//, '')
-        file = file.replace(/^tests\//, '')
+        file = file.replace(RegExp("^" + gTestBase + "/"), '')
 
         // Match directory or filename, gTestList has tests/<path>
-        if (tmp_path.match("^tests/" + file) != null) {
+        if (tmp_path.match("^" + gTestBase + "/" + file) != null) {
           filteredTests.push(test_path);
           break;
         }
@@ -260,10 +261,10 @@
       for (var f in excludetests) {
         // Remove leading /tests/ if exists
         file = f.replace(/^\//, '')
-        file = file.replace(/^tests\//, '')
+        file = file.replace(RegExp("^" + gTestBase + "/"), '');
 
         // Match directory or filename, gTestList has tests/<path>
-        if (tmp_path.match("^tests/" + file) != null) {
+        if (tmp_path.match("^" + gTestBase + "/" + file) != null) {
           found = true;
           break;
         }
Index: firefox-trunk-20.0~a1~hg20121121r113867/testing/mochitest/harness-overlay.xul
===================================================================
--- firefox-trunk-20.0~a1~hg20121121r113867.orig/testing/mochitest/harness-overlay.xul	2012-11-21 23:22:36.000000000 +0000
+++ firefox-trunk-20.0~a1~hg20121121r113867/testing/mochitest/harness-overlay.xul	2012-11-22 23:16:55.281667264 +0000
@@ -52,6 +52,7 @@
     document.getElementById("test-table").innerHTML += tableContent;
   }
   gTestList = eval(srvScope.jsonArrayOfTestFiles(links));
+  gTestBase = "chrome://mochitests/content";
   populate();
 
   hookup();
Index: firefox-trunk-20.0~a1~hg20121121r113867/testing/mochitest/server.js
===================================================================
--- firefox-trunk-20.0~a1~hg20121121r113867.orig/testing/mochitest/server.js	2012-11-21 23:22:36.000000000 +0000
+++ firefox-trunk-20.0~a1~hg20121121r113867/testing/mochitest/server.js	2012-11-22 23:15:38.637664554 +0000
@@ -601,7 +601,7 @@
         SCRIPT({type: "text/javascript",
                  src: "/tests/SimpleTest/setup.js"}),
         SCRIPT({type: "text/javascript"},
-               "window.onload =  hookup; gTestList=" + tests + ";"
+               "window.onload =  hookup; gTestList=" + tests + "; gTestBase = \"tests\";"
         )
       ),
       BODY(
