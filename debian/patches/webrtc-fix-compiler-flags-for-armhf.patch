# Description: Don't pass -mfloat-abi=softfp on armhf
# Author: Chris Coulson <chris.coulson@canonical.com>
# Forwarded: no

--- a/media/webrtc/trunk/webrtc/build/common.gypi
+++ b/media/webrtc/trunk/webrtc/build/common.gypi
@@ -434,8 +434,7 @@
             'defines': ['WEBRTC_ARCH_ARM_V7',
                         'WEBRTC_BUILD_NEON_LIBS',
                         'WEBRTC_HAS_NEON'],
-            'cflags_mozilla': ['-mfloat-abi=softfp',
-                               '-mfpu=neon'],
+            'cflags_mozilla': ['-mfpu=neon'],
           }],
         ],
       }],
--- a/build/gyp.mozbuild
+++ b/build/gyp.mozbuild
@@ -107,9 +107,15 @@
         gyp_vars['arm_neon'] = 1
         gyp_vars['build_with_neon'] = 1
     else:
-        # CPU detection for ARM works on Android only.  armv7 always uses CPU
-        # detection, so we have to set armv7=0 for non-Android target
-        gyp_vars['armv7'] = 0
+        gyp_vars['armv7'] = 1
+        # We enable NEON for Ubuntu armhf. Note that these don't really
+        # have any effect here as NEON is hardcoded on in
+        # media/webrtc/trunk/webrtc/build/common.gypi. Disabling these
+        # without fixing that file will result in a link failure, as
+        # targets hidden behind the build_with_neon flag don't get
+        # built but WEBRTC_HAS_NEON is still defined
+        gyp_vars['arm_neon'] = 1
+        gyp_vars['build_with_neon'] = 1
     # For libyuv
     gyp_vars['arm_version'] = int(CONFIG['ARM_ARCH'])
 
