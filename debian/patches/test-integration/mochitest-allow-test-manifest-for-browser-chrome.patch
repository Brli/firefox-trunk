# HG changeset patch
# Parent 0e8cbb3674e7a0aaa09daa97e5c91f002219ce06
# User Chris Coulson <chris.coulson@canonical.com>

diff --git a/testing/mochitest/browser-harness.xul b/testing/mochitest/browser-harness.xul
--- a/testing/mochitest/browser-harness.xul
+++ b/testing/mochitest/browser-harness.xul
@@ -190,17 +190,22 @@
       var fileNameRegexp = /browser_.+\.js$/;
       srvScope.arrayOfTestFiles(links, fileNames, fileNameRegexp);
 
       if (gConfig.totalChunks && gConfig.thisChunk) {
         fileNames = chunkifyTests(fileNames, gConfig.totalChunks,
                                   gConfig.thisChunk, gConfig.chunkByDir);
       }
 
-      createTester(fileNames.map(function (f) { return new browserTest(f); }));
+      function loadTestList2(manifest) {
+        fileNames = filterTests(manifest, fileNames, false, gConfig);
+        createTester(fileNames.map(function (f) { return new browserTest(f); }));
+      }
+
+      getTestManifest("http://mochi.test:8888/" + gConfig.testManifest, null, loadTestList2);
     }
 
     function setStatus(aStatusString) {
       document.getElementById("status").value = aStatusString;
     }
 
     function createTester(links) {
       var windowMediator = Cc['@mozilla.org/appshell/window-mediator;1'].
diff --git a/testing/mochitest/manifestLibrary.js b/testing/mochitest/manifestLibrary.js
--- a/testing/mochitest/manifestLibrary.js
+++ b/testing/mochitest/manifestLibrary.js
@@ -55,23 +55,25 @@ function getTestManifest(url, params, ca
  testList
  parameters:
    filter = json object of runtests | excludetests
    testList = array of test names to run
    runOnly = use runtests vs excludetests in case both are defined
  returns:
    filtered version of testList
 */
-function filterTests(filter, testList, runOnly) {
+function filterTests(filter, testList, runOnly, c) {
 
   var filteredTests = [];
   var removedTests = [];
   var runtests = {};
   var excludetests = {};
 
+  var config = c || config;
+
   if (filter == null) {
     return testList;
   }
 
   if ('runtests' in filter) {
     runtests = filter.runtests;
   }
   if ('excludetests' in filter) {
